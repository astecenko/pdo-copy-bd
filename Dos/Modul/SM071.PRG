#include "Set.ch"
/*//перевод из основной в заданную и из исходной в основную
static aArray1 :={;
'01 01 шт.  шт. ','02 01 10шт.шт. ','03 01 100штшт. ','04 01 т.шт.шт. ',;
'05 05 м    м   ','06 05 дм   м   ','07 07 м2   м2  ','08 08 м3   м3  ',;
'09 09 л    л   ','10 09 дл   л   ','11 13 т    кг  ','12 13 ц    кг  ',;
'13 13 кг   кг  ','14 13 г    кг  ','15 13 мг   кг  ','16 16 пара пара',;
'17 17 комплкомп','18 18 кар  кар ','19 19 лист лист','20 09 мл   л   ',;
'21 19 с.лстлист','22 22 рулонруло','23 23 кат. кат.','24 07 см2  м2  ',;
'25 07 дм2  м2  ','26 05 мм   м   ','27 05 10м  м   ','28 05 100м м   ',;
'29 05 см   м   ','30 05 км   м   ','31 01 дт.штшт. ','32 08 дм3  м3  ',;
'33 07 т.м2 м2  ','34 08 т.м3 м3  ','35 01 шт.-1шт. ','36 01 шт.-2шт. ',;
'37 01 шт.-3шт. ','38 38 упак.упак','39 39 боб. боб.','40 40 бал. бал.',;
'41 41 банкабанк','42 42 бараббара','43 43 б.кг б.кг','44 44 блок блок',;
'45 45 пог.мпог.','46 46 бочкабочк','47 47 канискани','48 48 коробкоро',;
'49 49 пачкапачк','50 50 полосполо','51 51 руб  руб ','52 52 тюбиктюби',;
'53 53 ф.кг ф.кг','54 54 ящик ящик'}

//коэффициенты перевода
   static aArray2 :={;
'01 0000010000000','02 0000100000000','03 0001000000000','04 0010000000000',;
'05 0000010000000','06 0000001000000','07 0000010000000','08 0000010000000',;
'09 0000010000000','10 0000001000000','11 0010000000000','12 0001000000000',;
'13 0000010000000','14 0000000010000','15 0000000000010','16 0000010000000',;
'17 0000010000000','18 0000010000000','19 0000010000000','20 0000000010000',;
'21 0001000000000','22 0000010000000','23 0000010000000','24 0000000001000',;
'25 0000000100000','26 0000000010000','27 0000100000000','28 0001000000000',;
'29 0000000100000','30 0010000000000','31 0100000000000','32 0000000010000',;
'33 0010000000000','34 0010000000000','35 0000001000000','36 0000000100000',;
'37 0000000010000','38 0000010000000','39 0000010000000','40 0000010000000',;
'41 0000010000000','42 0000010000000','43 0000010000000','44 0000010000000',;
'45 0000010000000','46 0000010000000','47 0000010000000','48 0000010000000',;
'49 0000010000000','50 0000010000000','51 0000010000000','52 0000010000000',;
'53 0000010000000','54 0000010000000'}

    static aArray3 :={;
'01 Штука                  Штука                   ','02 10 штук                Штука                   ',;
'03 100 штук               Штука                   ','04 1000 штук              Штука                   ',;
'05 Метр                   Метр                    ','06 Дециметр               Метр                    ',;
'07 Квадpатный метр        Квадратный метр         ','08 Кубический метр        Кубический метр         ',;
'09 Литр                   Литр                    ','10 Децилитр               Литр                    ',;
'11 Тонна                  Килограмм               ','12 Центнер                Килограмм               ',;
'13 Килограмм              Килограмм               ','14 Грамм                  Килограмм               ',;
'15 Миллиграмм             Миллиграмм              ','16 Пара                   Пара (2 шт.)            ',;
'17 Комплектный набор      Комплектный набор       ','18 Карат                  Карат                   ',;
'19 Лист                   Лист                    ','20 Миллилитр              Литр                    ',;
'21 100 листов             Лист                    ','22 Рулон                  Рулон                   ',;
'23 Катушка                Катушка                 ','24 Квадратный сантиметр   Квадратный метр         ',;
'25 Квадратный дециметр    Квадратный метр         ','26 Миллиметр              Метр                    ',;
'27 10 метров              Метр                    ','28 100 метров             Метр                    ',;
'29 Сантиметр              Метр                    ','30 Километр               Метр                    ',;
'31 10000 штук             Штука                   ','32 Кубический дециметр    Кубический метр         ',;
'33 1000 квадратных метров Квадратный метр         ','34 1000 кубических метров Кубический метр         ',;
'35 0,1 штуки              Штука                   ','36 0,01 штуки             Штука                   ',;
'37 0,001 штуки            Штука                   ','38 Упаковка               Упаковка                ',;
'39 Бобина                 Бобина                  ','40 Баллон                 Баллон                  ',;
'41 Банка                  Банка                   ','42 Барабан                Барабан                 ',;
'43 Базовый килограмм      Базовый килограмм       ','44 Блок                   Блок                    ',;
'45 Погонный метр          Погонный метр           ','46 Бочка                  Бочка                   ',;
'47 Канистра               Канистра                ','48 Коробка                Коробка                 ',;
'49 Пачка                  Пачка                   ','50 Полоска                Полоска                 ',;
'51 Рубль                  Рубль                   ','52 Тюбик                  Тюбик                   ',;
'53 Физический килограмм   Физический килограмм    ','54 Ящик                   Ящик                    '}

//перевод из основной в заданную с приоритетом
 static aArray4 :={ ;
         {'01',{'37','36','35','01','02','03','04','31'}},;
         {'05',{'26','29','06','05','27','28','30'}},;
         {'07',{'24','25','07','33'}},;
         {'08',{'32','08','34'}},;
         {'09',{'20','10','09'}},;
         {'13',{'15','14','13','12','11'}},;
         {'16',{}},;
         {'17',{}},;
         {'18',{}},;
         {'19',{'19','21'}},;
         {'22',{}},;
         {'23',{}},;
         {'38',{}},;
         {'39',{}},;
         {'40',{}},;
         {'41',{}},;
         {'42',{}},;
         {'43',{}},;
         {'44',{}},;
         {'45',{}},;
         {'46',{}},;
         {'47',{}},;
         {'48',{}},;
         {'49',{}},;
         {'50',{}},;
         {'51',{}},;
         {'52',{}},;
         {'53',{}},;
         {'54',{}}}
*/
********** ПЕРЕВОД ЕДИНИЦ ИЗМЕРЕНИЯ *******************************************
FUNC sm071(bu,isei,isxp,rezp,namei,zei,shabl)
local bu1 := substr(bu,1,1)
local bu2 := substr(bu,2,1)
local nzap := val(isei)
local pei := isei,lmas,pzei,nei
local drob := 0,celoe := 0,cel_shabl,dr_shabl,npoz1
LOCAL eii,eio,kper,ns1,ns2,ns3
LOCAL decim := set(3)
//перевод из основной в заданную и из исходной в основную
aArray1 :={;
'01 01 шт.  шт.  ','02 01 10шт.шт.  ','03 01 100штшт.  ','04 01 т.шт.шт.  ',;
'05 05 м    м    ','06 05 дм   м    ','07 07 м2   м2   ','08 08 м3   м3   ',;
'09 09 л    л    ','10 09 дл   л    ','11 13 т    кг   ','12 13 ц    кг   ',;
'13 13 кг   кг   ','14 13 г    кг   ','15 13 мг   кг   ','16 16 пара пара ',;
'17 17 комплкомпл','18 18 кар  кар  ','19 19 лист лист ','20 09 мл   л    ',;
'21 19 с.лстлист ','22 22 рулонрулон','23 23 кат. кат. ','24 07 см2  м2   ',;
'25 07 дм2  м2   ','26 05 мм   м    ','27 05 10м  м    ','28 05 100м м    ',;
'29 05 см   м    ','30 05 км   м    ','31 01 дт.штшт.  ','32 08 дм3  м3   ',;
'33 07 т.м2 м2   ','34 08 т.м3 м3   ','35 01 шт.-1шт.  ','36 01 шт.-2шт.  ',;
'37 01 шт.-3шт.  ','38 38 упак.упак.','39 39 боб. боб. ','40 40 бал. бал. ',;
'41 41 банкабанка','42 42 бараббараб','43 43 б.кг б.кг ','44 44 блок блок ',;
'45 45 пог.мпог.м','46 46 бочкабочка','47 47 канисканис','48 48 коробкороб',;
'49 49 пачкапачка','50 50 полосполос','51 51 руб  руб  ','52 52 тюбиктюбик',;
'53 53 ф.кг ф.кг ','54 54 ящик ящик '}

//коэффициенты перевода
aArray2 :={;
'01 0000010000000','02 0000100000000','03 0001000000000','04 0010000000000',;
'05 0000010000000','06 0000001000000','07 0000010000000','08 0000010000000',;
'09 0000010000000','10 0000001000000','11 0010000000000','12 0001000000000',;
'13 0000010000000','14 0000000010000','15 0000000000010','16 0000010000000',;
'17 0000010000000','18 0000010000000','19 0000010000000','20 0000000010000',;
'21 0001000000000','22 0000010000000','23 0000010000000','24 0000000001000',;
'25 0000000100000','26 0000000010000','27 0000100000000','28 0001000000000',;
'29 0000000100000','30 0010000000000','31 0100000000000','32 0000000010000',;
'33 0010000000000','34 0010000000000','35 0000001000000','36 0000000100000',;
'37 0000000010000','38 0000010000000','39 0000010000000','40 0000010000000',;
'41 0000010000000','42 0000010000000','43 0000010000000','44 0000010000000',;
'45 0000010000000','46 0000010000000','47 0000010000000','48 0000010000000',;
'49 0000010000000','50 0000010000000','51 0000010000000','52 0000010000000',;
'53 0000010000000','54 0000010000000'}

aArray3 :={;
'01 Штука                  Штука                   ','02 10 штук                Штука                   ',;
'03 100 штук               Штука                   ','04 1000 штук              Штука                   ',;
'05 Метр                   Метр                    ','06 Дециметр               Метр                    ',;
'07 Квадpатный метр        Квадратный метр         ','08 Кубический метр        Кубический метр         ',;
'09 Литр                   Литр                    ','10 Децилитр               Литр                    ',;
'11 Тонна                  Килограмм               ','12 Центнер                Килограмм               ',;
'13 Килограмм              Килограмм               ','14 Грамм                  Килограмм               ',;
'15 Миллиграмм             Миллиграмм              ','16 Пара                   Пара (2 шт.)            ',;
'17 Комплектный набор      Комплектный набор       ','18 Карат                  Карат                   ',;
'19 Лист                   Лист                    ','20 Миллилитр              Литр                    ',;
'21 100 листов             Лист                    ','22 Рулон                  Рулон                   ',;
'23 Катушка                Катушка                 ','24 Квадратный сантиметр   Квадратный метр         ',;
'25 Квадратный дециметр    Квадратный метр         ','26 Миллиметр              Метр                    ',;
'27 10 метров              Метр                    ','28 100 метров             Метр                    ',;
'29 Сантиметр              Метр                    ','30 Километр               Метр                    ',;
'31 10000 штук             Штука                   ','32 Кубический дециметр    Кубический метр         ',;
'33 1000 квадратных метров Квадратный метр         ','34 1000 кубических метров Кубический метр         ',;
'35 0,1 штуки              Штука                   ','36 0,01 штуки             Штука                   ',;
'37 0,001 штуки            Штука                   ','38 Упаковка               Упаковка                ',;
'39 Бобина                 Бобина                  ','40 Баллон                 Баллон                  ',;
'41 Банка                  Банка                   ','42 Барабан                Барабан                 ',;
'43 Базовый килограмм      Базовый килограмм       ','44 Блок                   Блок                    ',;
'45 Погонный метр          Погонный метр           ','46 Бочка                  Бочка                   ',;
'47 Канистра               Канистра                ','48 Коробка                Коробка                 ',;
'49 Пачка                  Пачка                   ','50 Полоска                Полоска                 ',;
'51 Рубль                  Рубль                   ','52 Тюбик                  Тюбик                   ',;
'53 Физический килограмм   Физический килограмм    ','54 Ящик                   Ящик                    '}

//перевод из основной в заданную с приоритетом
aArray4 :={ ;
         {'01',{'37','36','35','01','02','03','04','31'}},;
         {'05',{'26','29','06','05','27','28','30'}},;
         {'07',{'24','25','07','33'}},;
         {'08',{'32','08','34'}},;
         {'09',{'20','10','09'}},;
         {'13',{'15','14','13','12','11'}},;
         {'16',{}},;
         {'17',{}},;
         {'18',{}},;
         {'19',{'19','21'}},;
         {'22',{}},;
         {'23',{}},;
         {'38',{}},;
         {'39',{}},;
         {'40',{}},;
         {'41',{}},;
         {'42',{}},;
         {'43',{}},;
         {'44',{}},;
         {'45',{}},;
         {'46',{}},;
         {'47',{}},;
         {'48',{}},;
         {'49',{}},;
         {'50',{}},;
         {'51',{}},;
         {'52',{}},;
         {'53',{}},;
         {'54',{}}}

set decimals to 16
rezp := 0
IF bu2='9'
   bu:=bu1 + '8'
   bu2:=substr(bu,2,1)
ENDIF
IF bu2='8' .And. shabl # NIL  //с приоритетом?
   shabl:=Val(shabl)
   opr_cel(shabl,@cel_shabl,@dr_shabl)
   ns1:=AScan(aArray4, { |i| i[1] = isei } )
   IF ns1 # 0
      IF Empty(aArray4[ns1][2])  //16,17,18 е.и.
         opr_cel(isxp,@celoe,@drob)
         IF drob > dr_shabl
            bu:=bu1+'9' //потеря значности млд.разрядов
         ENDIF
         set decimals to dr_shabl
         set fixed on
         rezp:=str(isxp)
         rezp:=val(rezp)
         set decimals to 16
         //rezp:=Round(isxp,dr_shabl)
         zei:=isei
         nei:=Val(zei)
         namei=SubStr(aArray1[nei],7,10)
         set decimals to decim
         IF celoe <= cel_shabl
            Return .T.
         ELSE
            Return .F.
         ENDIF
      ENDIF
      ns2:=AScan(aArray4[ns1][2], { |i| i = zei })
      IF ns2 # 0  //можно попытаться перевести в заданную еи
         nzapp:=Val(aArray4[ns1][2][ns2])
         opr_rezp(nzapp,bu1,isxp,@rezp)
         opr_cel(rezp,@celoe,@drob)
         IF celoe < cel_shabl
            IF drob <= dr_shabl
               REZ_SM07(@rezp,@zei,@namei,cel_shabl,dr_shabl,nzapp)
               Set Decimals To decim
               Return .T.
            ELSE //пытаемся перевести так, чтобы помещались и целые и дробные
               prezp:=rezp
               pnzapp:=nzapp
               If bu1='0' //норма
                  for_beg:=ns2-1
                  for_end:=1
                  for_step:=-1
               ElseIf bu1='8' //цена
                  for_beg:=ns2+1
                  for_end:=Len(aArray4[ns1][2])
                  for_step:=1
               EndIf
               For j:=for_beg To for_end Step for_step
                   nzapp:=Val(aArray4[ns1][2][j])
                   opr_rezp(nzapp,bu1,isxp,@rezp)
                   opr_cel(rezp,@celoe,@drob)
                   If celoe <= cel_shabl
                      If drob <= dr_shabl
                         REZ_SM07(@rezp,@zei,@namei,cel_shabl,dr_shabl,nzapp)
                         Set Decimals To decim
                         Return .T.
                      EndIf
                      prezp:=rezp
                      pnzapp:=nzapp
                   Else
                      bu:=bu1+'9' //потеря значности млд.разрядов
                      rezp:=prezp
                      nzapp:=pnzapp
                      REZ_SM07(@rezp,@zei,@namei,cel_shabl,dr_shabl,nzapp)
                      Set Decimals To decim
                      Return .T.
                   EndIf
               Next
               bu:=bu1+'9' //потеря значности млд.разрядов
               REZ_SM07(@rezp,@zei,@namei,cel_shabl,dr_shabl,nzapp)
               Set Decimals To decim
               Return .T.
            ENDIF
         ELSEIF celoe = cel_shabl
            IF drob > dr_shabl
               bu:=bu1+'9' //потеря значности млд.разрядов
            ENDIF
            REZ_SM07(@rezp,@zei,@namei,cel_shabl,dr_shabl,nzapp)
            Set Decimals To decim
            Return .T.
         ELSE    //celoe > cel_shabl
            If bu1='0' //норма
               for_beg:=ns2+1
               for_end:=Len(aArray4[ns1][2])
               for_step:=1
            ElseIf bu1='8' //цена
               for_beg:=ns2-1
               for_end:=1
               for_step:=-1
            EndIf
            For j:=for_beg To for_end Step for_step
                nzapp:=Val(aArray4[ns1][2][j])
                opr_rezp(nzapp,bu1,isxp,@rezp)
                opr_cel(rezp,@celoe,@drob)
                If celoe <= cel_shabl
                   If drob > dr_shabl
                      bu:=bu1+'9' //потеря значности млд.разрядов
                   EndIf
                   REZ_SM07(@rezp,@zei,@namei,cel_shabl,dr_shabl,nzapp)
                   Set Decimals To decim
                   Return .T.
                EndIf
            Next
            //потеря старших разрядов
           // REZ_SM07(@rezp,@zei,@namei,cel_shabl,dr_shabl,nzapp)
            Set Decimals To decim
            Return .F.
         EndIf
      ELSE
         set decimals to decim
         Return .F. //основную еи нельзя перевести в заданную еи
      ENDIF
   ELSE             //еи не основная
      set decimals to decim
      Return .F.
   ENDIF

ElseIf (bu1='0'.or.bu1='8').and.(bu2='0'.or.bu2='2'.or.bu2='4')  && 1
  if bu2='2'                          && (1a)  из основной в заданную?
        nzap=val(zei)
        pei=zei
  endif                               && (1a)

  if nzap>0 .and.nzap<38                        && (2)
        eii=substr(aArray1[nzap],1,2)      && заданная еи
        eio=substr(aArray1[nzap],4,2)      && основная еи
        if pei=eii                    && (3) есть в таблице?
           if eio#'  '                && (3a) только зарезервировано место?
             namei=substr(aArray1[nzap],7,10)
             kper=val(substr(aArray2[nzap],4,13))/10000000
             if bu2#'4'              && (4) не проверка на допустимость?
                if  bu2='0'           && (5) пеpевод из исходной в основную?
********** ПЕРЕВОД ИЗ ИСХОДНОЙ В ОСНОВНУЮ ЕИ *********************************
                  if bu1='8'          && (6) пеpевод цены?
                    rezp=isxp/kper    && да
                  else                && (6)
                    rezp=isxp*kper     && поле результата
                  endif 6
                  zei=eio            && основная еи
                 else                 && (5) иначе
********** ПЕРЕВОД ИЗ ОСНОВНОЙ В ЗАДАННУЮ ***********************************
                      if eio=isei     && (8)
                         if bu1='8'   && (7) пеpевод цены?
                           rezp=isxp*kper
                         else         && (7)
                           rezp=isxp/kper
                         endif 7
                       else           && (8)
*********** ВЫХОД ПО ОШИБКАМ *************************************************
                       set decimals to decim
                       return (.f.)
                       endif 8
                  endif 5
             endif 4
           else                       && (3a)
             set decimals to decim
             return (.f.)
           endif                      && (3a)
        else                          && (3)
         set decimals to decim
         return (.f.)
        endif 3
  else                             && (2)
      set decimals to decim
      return (.f.)
  endif 2
else                                && (1)
  set decimals to decim
  return (.f.)
endif 1
set decimals to decim
return (.t.)

*********************
FUNCTION opr_cel(rezp,cel,dr)
LOCAL st := alltrim(str(rezp))
LOCAL npoz1 := at('.',st)
LOCAL i, dl_m
cel := len(ltrim(str(int(rezp))))
dr := len(st)-npoz1
st_dr := substr(st,npoz1+1,dr)
dl_m := len(st_dr)
sm := dl_m
FOR i := 1 TO  dl_m
  IF substr(st_dr,sm,1) = "0"
    sm --
  ELSE
    st_dr := substr(st_dr,1,sm)
    dr := len(st_dr)
    exit
  ENDIF
NEXT
IF sm = 0
  dr := 0
ENDIF
RETURN
*********************************
FUNCTION opr_rezp(nzapp,bu1,isxp,rezp)
 kper=val(substr(aArray2[nzapp],4,13))/10000000
 IF bu1='8'   // пеpевод цены?
     rezp=isxp*kper    // цена
 ELSE
     rezp=isxp/kper     // норма
 ENDIF
 rezp := rezp*1
RETURN(rezp)
**********************************
FUNCTION REZ_SM07(rezp,zei,namei,cel_shabl,dr_shabl,nzapp)
LOCAL pzei,nei
//rezp := round(rezp,dr_shabl)
set decimals to dr_shabl
set fixed on
rezp:=str(rezp)
rezp:=val(rezp)
set decimals to 16
rezp := val(padl(ltrim( str(rezp) ),cel_shabl+dr_shabl+1))
pzei:= alltrim(str(nzapp))
zei := if(len(pzei)>1,pzei,'0'+pzei)
nei := val(zei)
namei=substr(aArray1[nei],7,10)
RETURN
